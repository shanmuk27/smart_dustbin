<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Dustbin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .active-view { display: block; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #fff; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 max-w-4xl">

        <div id="guest-view" class="view">
            <header class="text-center mb-8"><h1 class="text-4xl font-bold text-gray-900">Smart Dustbin Project</h1><p class="text-lg text-gray-600 mt-2">Segregate waste, earn points, and make a difference!</p></header>
            <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-semibold text-center mb-4">Leaderboard</h2><div id="leaderboard-list-guest" class="space-y-3"></div></div>
            <div class="text-center mt-8">
                <button onclick="showView('login-view')" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Login</button>
                <button onclick="showView('register-view')" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition ml-4">Register</button>
            </div>
        </div>

        <div id="login-view" class="view"><div class="bg-white p-10 rounded-lg shadow-lg max-w-md mx-auto"><h2 class="text-2xl font-bold text-center mb-6">Login</h2><form id="login-form"><div class="mb-4"><label for="login-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><button id="login-submit-button" type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex justify-center items-center">Login</button></form><p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p><p class="text-center text-sm text-gray-600 mt-4">Don't have an account? <a href="#" onclick="showView('register-view')" class="font-medium text-blue-600 hover:underline">Register here</a></p></div></div>
        <div id="register-view" class="view"><div class="bg-white p-10 rounded-lg shadow-lg max-w-md mx-auto"><h2 class="text-2xl font-bold text-center mb-6">Create Account</h2><form id="register-form"><div class="mb-4"><label for="register-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div class="mb-6"><label for="register-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><button id="register-submit-button" type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition flex justify-center items-center">Register</button></form><p id="register-error" class="text-red-500 text-sm mt-4 text-center"></p><p class="text-center text-sm text-gray-600 mt-4">Already have an account? <a href="#" onclick="showView('login-view')" class="font-medium text-blue-600 hover:underline">Login here</a></p></div></div>

        <div id="dashboard-view" class="view">
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                <h1 class="text-3xl font-bold">Your Dashboard</h1>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-sm font-medium p-2 bg-gray-100 rounded-full">
                        <span id="bin-status-dot" class="status-dot bg-gray-400"></span>
                        <span id="bin-status-text">Checking...</span>
                    </div>
                    <button onclick="handleLogout()" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition">Logout</button>
                    <button onclick="handleDeleteAccount()" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete Account</button>
                </div>
            </header>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="bg-gray-100 border p-6 rounded-lg text-center"><p class="text-sm font-medium text-gray-500">Total Points</p><p id="total-points" class="text-3xl font-bold text-blue-600">0</p></div><div class="bg-gray-100 border p-6 rounded-lg text-center"><p class="text-sm font-medium text-gray-500">Dry Waste</p><p id="dry-points" class="text-3xl font-bold">0</p></div><div class="bg-gray-100 border p-6 rounded-lg text-center"><p class="text-sm font-medium text-gray-500">Wet Waste</p><p id="wet-points" class="text-3xl font-bold">0</p></div><div class="bg-gray-100 border p-6 rounded-lg text-center"><p class="text-sm font-medium text-gray-500">E-Waste</p><p id="ewaste-points" class="text-3xl font-bold">0</p></div></div>
            <div id="link-dustbin-section" class="bg-white p-8 rounded-lg shadow-md mb-8"><h2 class="text-xl font-semibold mb-4">Link Your Dustbin</h2><p class="text-sm text-gray-600 mb-4">Enter the unique ID from your Arduino device to start earning points.</p><form id="link-dustbin-form" class="flex items-center gap-4"><input type="text" id="dustbin-id-input" placeholder="e.g., dustbin_001" required class="flex-grow block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Link</button></form><p id="link-status" class="text-sm mt-2"></p></div>
            
            <div id="linked-dustbin-display" class="hidden items-center justify-center text-lg mb-8 gap-4">
                <span>Linked to: <span id="linked-id" class="font-semibold text-blue-600"></span></span>
                <button onclick="handleUnlinkDustbin()" class="bg-yellow-500 text-white font-semibold text-sm py-1 px-3 rounded-lg hover:bg-yellow-600 transition">Unlink</button>
            </div>
            
            <div class="bg-white p-8 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4">AI Sustainability Coach</h2>
                <p class="text-sm text-gray-600 mb-4">Ask a question about your habits or how to improve.</p>
                <form id="ai-coach-form">
                    <div class="flex items-center gap-4 mb-4">
                        <input type="text" id="ai-prompt-input" placeholder="How can I earn money from my e-waste?" required class="flex-grow block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="ai-coach-button" type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition flex justify-center items-center">Ask</button>
                    </div>
                </form>

                <div id="quick-questions" class="flex flex-wrap items-center gap-2 mt-4 text-sm">
                    <span class="font-medium text-gray-600">Try asking:</span>
                    <button type="button" class="quick-question-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300 transition">How can I reduce my wet waste?</button>
                    <button type="button" class="quick-question-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300 transition">Benefits of recycling e-waste?</button>
                    <button type="button" class="quick-question-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300 transition">Give me a tip for earning points.</button>
                </div>

                <div id="ai-response" class="hidden mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg"></div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8"><h2 class="text-2xl font-semibold text-center mb-4">Leaderboard</h2><div id="leaderboard-list-dashboard" class="space-y-3"></div></div>
        </div>
    </div>

<script>
    const BASE_URL = ''; 

    const api = {
        // MODIFIED request method to handle DELETE
        async request(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
            };
            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(`${BASE_URL}/${endpoint}`, options);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'An unknown error occurred.');
                return data;
            } catch (error) {
                console.error(`API Error on ${method} ${endpoint}:`, error);
                throw error;
            }
        }
    };

    const views = document.querySelectorAll('.view');
    function showView(viewId) {
        views.forEach(view => view.classList.remove('active-view'));
        document.getElementById(viewId).classList.add('active-view');
    }

    const ui = {
        setLoading(button, isLoading) {
            if (!button) return;
            button.disabled = isLoading;
            if (isLoading) {
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = `<div class="spinner"></div>`;
            } else {
                button.innerHTML = button.dataset.originalText || 'Submit';
            }
        },
        renderLeaderboard(leaderboards) {
            const lists = [document.getElementById('leaderboard-list-guest'), document.getElementById('leaderboard-list-dashboard')];
            lists.forEach(list => {
                list.innerHTML = '';
                if (leaderboards.length === 0) {
                    list.innerHTML = `<p class="text-gray-500 text-center">No data yet. Be the first!</p>`;
                    return;
                }
                leaderboards.forEach((user, index) => {
                    list.innerHTML += `<div class="flex justify-between items-center p-2 rounded-md ${index < 3 ? 'bg-yellow-50' : ''}"><span class="font-semibold">${index + 1}. ${user.email}</span><span class="font-bold text-blue-600">${user.total_points} Points</span></div>`;
                });
            });
        },
        updateDashboard(userData) {
            const points = userData.points || { total: 0, dry: 0, wet: 0, ewaste: 0 };
            document.getElementById('total-points').textContent = points.total;
            document.getElementById('dry-points').textContent = points.dry;
            document.getElementById('wet-points').textContent = points.wet;
            document.getElementById('ewaste-points').textContent = points.ewaste;
            
            const linkSection = document.getElementById('link-dustbin-section');
            const linkedDisplay = document.getElementById('linked-dustbin-display');

            if (userData.linked_dustbin) {
                linkSection.classList.add('hidden');
                linkedDisplay.classList.remove('hidden');
                // MODIFIED to be a flex container for centering
                linkedDisplay.style.display = 'flex';
                document.getElementById('linked-id').textContent = userData.linked_dustbin;
            } else {
                linkSection.classList.remove('hidden');
                linkedDisplay.classList.add('hidden');
            }
        },
        updateBinStatus(statusData) {
            const dot = document.getElementById('bin-status-dot');
            const text = document.getElementById('bin-status-text');
            dot.className = "status-dot"; 
            if (statusData.status === 'Connected') {
                text.textContent = 'Bin Connected';
                dot.classList.add('bg-green-500');
            } else {
                text.textContent = 'Bin Offline';
                dot.classList.add('bg-red-500');
            }
        }
    };

    let refreshInterval;

    async function showDashboard() {
        const uid = localStorage.getItem('userUID');
        if (!uid) { handleLogout(); return; }
        showView('dashboard-view');
        await Promise.all([loadLeaderboards(), loadDashboardData(), updateBinStatus()]);
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(() => {
            loadDashboardData();
            updateBinStatus();
        }, 5000);
    }

    async function loadDashboardData() {
        try {
            const userData = await api.request(`user/${localStorage.getItem('userUID')}`);
            ui.updateDashboard(userData);
        } catch (error) {
            console.error('Failed to load dashboard data:', error);
            handleLogout();
        }
    }
    
    async function updateBinStatus() {
        try {
            const status = await api.request('arduino_status');
            ui.updateBinStatus(status);
        } catch (error) {
            ui.updateBinStatus({ status: 'Offline' });
        }
    }

    async function loadLeaderboards() {
        try {
            const leaderboards = await api.request('leaderboard');
            ui.renderLeaderboard(leaderboards);
        } catch (error) { console.error('Failed to load leaderboards:', error); }
    }
    
    async function handleAuth(event, formId, endpoint) {
        event.preventDefault();
        const form = document.getElementById(formId);
        const button = form.querySelector('button[type="submit"]');
        const errorP = form.nextElementSibling;
        errorP.textContent = '';
        ui.setLoading(button, true);
        try {
            const body = { email: form.elements[0].value, password: form.elements[1].value };
            const response = await api.request(endpoint, 'POST', body);
            if (endpoint === 'register') {
                alert('Registration successful! Please login.');
                showView('login-view');
            } else {
                localStorage.setItem('userUID', response.uid);
                await showDashboard();
            }
        } catch (error) {
            errorP.textContent = error.message;
        } finally {
            ui.setLoading(button, false);
        }
    }
    
    function handleLogout() {
        localStorage.removeItem('userUID');
        clearInterval(refreshInterval);
        showView('guest-view');
    }

    async function handleLinkDustbin(event) {
        event.preventDefault();
        const dustbinId = document.getElementById('dustbin-id-input').value;
        const statusP = document.getElementById('link-status');
        statusP.textContent = 'Linking...';
        statusP.className = 'text-gray-600 text-sm mt-2'; // Reset color
        try {
            await api.request('link_dustbin', 'POST', { uid: localStorage.getItem('userUID'), dustbin_id: dustbinId });
            statusP.textContent = `Successfully linked!`;
            statusP.classList.add('text-green-600');
            await loadDashboardData();
        } catch (error) {
            statusP.textContent = `Error: ${error.message}`;
            statusP.classList.add('text-red-600');
        }
    }
    
    // --- NEW --- Function to handle unlinking a dustbin
    async function handleUnlinkDustbin() {
        if (!confirm('Are you sure you want to unlink this dustbin? You will stop receiving points.')) {
            return;
        }
        try {
            await api.request('unlink_dustbin', 'POST', { uid: localStorage.getItem('userUID') });
            alert('Dustbin unlinked successfully.');
            await loadDashboardData(); // Refresh the dashboard to show the linking form again
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // --- NEW --- Function to handle deleting an account
    async function handleDeleteAccount() {
        const confirmation = prompt('This action is irreversible. To confirm, please type DELETE below:');
        if (confirmation !== 'DELETE') {
            alert('Deletion cancelled.');
            return;
        }
        
        try {
            const uid = localStorage.getItem('userUID');
            await api.request(`user/${uid}`, 'DELETE');
            alert('Your account has been successfully deleted.');
            handleLogout(); // Log out and return to guest view
        } catch (error) {
            alert(`Failed to delete account: ${error.message}`);
        }
    }

    async function handleAiCoach(event) {
        event.preventDefault();
        const button = document.getElementById('ai-coach-button');
        const responseDiv = document.getElementById('ai-response');
        const promptInput = document.getElementById('ai-prompt-input');
        if (!promptInput.value.trim()) return;
        ui.setLoading(button, true);
        responseDiv.classList.add('hidden');
        try {
            const userData = await api.request(`user/${localStorage.getItem('userUID')}`);
            const advice = await api.request('ai_coach', 'POST', { user_data: userData, user_query: promptInput.value });
            responseDiv.innerHTML = `<p>${advice.response}</p>`;
            responseDiv.classList.remove('hidden');
        } catch (error) {
            responseDiv.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
            responseDiv.classList.remove('hidden');
        } finally {
            ui.setLoading(button, false);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', (e) => handleAuth(e, 'login-form', 'login'));
        document.getElementById('register-form').addEventListener('submit', (e) => handleAuth(e, 'register-form', 'register'));
        document.getElementById('link-dustbin-form').addEventListener('submit', handleLinkDustbin);
        document.getElementById('ai-coach-form').addEventListener('submit', handleAiCoach);
        
        const quickQuestionsContainer = document.getElementById('quick-questions');
        if (quickQuestionsContainer) {
            quickQuestionsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('quick-question-btn')) {
                    const question = event.target.textContent;
                    const promptInput = document.getElementById('ai-prompt-input');
                    const coachButton = document.getElementById('ai-coach-button');
                    promptInput.value = question;
                    coachButton.click();
                }
            });
        }
        
        if (localStorage.getItem('userUID')) {
            showDashboard();
        } else {
            showView('guest-view');
            loadLeaderboards();
        }
    });
</script>
</body>
</html>